<!DOCTYPE html>
<html>
<head>
  <title>Documents</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <h2>Uploaded Documents</h2>

  <!-- 🔍 Filters -->
  <label for="filterType">Filter by Type:</label>
  <select id="filterType" onchange="loadDocuments()">
    <option value="">All</option>
    <option value="driver">Driver</option>
    <option value="load">Load</option>
    <option value="truck">Truck</option>
  </select>

  <!-- 🔍 Search -->
  <input type="text" id="searchInput" placeholder="Search by filename or reference ID" />
  <button onclick="loadDocuments()">Search</button>

  <!-- 🔃 Sort Controls -->
  <label for="sortField">Sort by:</label>
  <select id="sortField" onchange="loadDocuments()">
    <option value="createdAt">Date</option>
    <option value="filename">Filename</option>
    <option value="associatedWith">Type</option>
  </select>
  <select id="sortOrder" onchange="loadDocuments()">
    <option value="DESC">Descending</option>
    <option value="ASC">Ascending</option>
  </select>

  <!-- ◀️ Pagination Controls -->
  <div class="controls">
    <button onclick="changePage(-1)">Previous</button>
    <span id="pageInfo">Page 1</span>
    <button onclick="changePage(1)">Next</button>
  </div>

  <!-- 📤 Upload Form -->
  <h3>Upload Document</h3>
  <form id="uploadForm" enctype="multipart/form-data">
    <input type="file" name="file" required />
    <input type="text" name="uploadedBy" placeholder="Uploaded By" required />
    <select name="associatedWith" required>
      <option value="driver">Driver</option>
      <option value="load">Load</option>
      <option value="truck">Truck</option>
    </select>
    <input type="text" name="referenceId" placeholder="Reference ID" required />
    <select name="category">
      <option value="">Select Category</option>
      <option value="invoices">Invoices</option>
      <option value="permits">Permits</option>
      <option value="insurance">Insurance</option>
    </select>
    <input type="text" name="folder" placeholder="Folder name (optional)" />
    <input type="text" name="tags" placeholder="Tags (comma-separated)" />
    <button type="submit">Upload</button>
  </form>

  <!-- 📄 Document Table -->
  <table id="docsTable" border="1">
    <thead>
      <tr>
        <th>ID</th>
        <th>Filename</th>
        <th>Type</th>
        <th>Uploaded By</th>
        <th>Reference ID</th>
        <th>Uploaded At</th>
        <th>Category</th>
        <th>Folder</th>
        <th>Tags</th>
        <th>Actions / Preview</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let currentPage = 1;
    let totalPages = 1;
    const limit = 10;

    function formatSize(bytes) {
      const kb = bytes / 1024;
      if (kb < 1024) return `${kb.toFixed(1)} KB`;
      const mb = kb / 1024;
      return `${mb.toFixed(1)} MB`;
    }

    async function loadDocuments() {
      const type = document.getElementById('filterType').value;
      const search = document.getElementById('searchInput').value;
      const sortField = document.getElementById('sortField').value || 'createdAt';
      const sortOrder = document.getElementById('sortOrder').value || 'DESC';

      let url = `/api/documents?page=${currentPage}&limit=${limit}&sortField=${sortField}&sortOrder=${sortOrder}`;
      if (type) url += `&type=${type}`;
      if (search) url += `&search=${encodeURIComponent(search)}`;

      const res = await fetch(url);
      const data = await res.json();

      totalPages = data.totalPages || 1;
      document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;

      const table = document.querySelector('#docsTable tbody');
      table.innerHTML = '';

      const userRole = sessionStorage.getItem('userRole') || 'guest';

      data.documents.forEach(doc => {
        const uploadDate = new Date(doc.createdAt).toLocaleString();
        const isAdmin = userRole === 'admin';

        const preview = doc.mimetype.startsWith('image/')
          ? `<img src="/uploads/${doc.filename}" width="100" />`
          : doc.mimetype === 'application/pdf'
            ? `<embed src="/uploads/${doc.filename}" width="100" height="100" type="application/pdf"/>`
            : '';

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${doc.id}</td>
          <td>${doc.filename}</td>
          <td>${doc.associatedWith}</td>
          <td>${doc.uploadedBy}</td>
          <td>${doc.referenceId}</td>
          <td>${uploadDate}</td>
          <td>${doc.category || ''}</td>
          <td>${doc.folder || ''}</td>
          <td>${doc.tags || ''}</td>
          <td>
            ${preview}
            <br>${formatSize(doc.size)} - ${doc.mimetype}
            <br>
            ${isAdmin 
              ? `<a href="/api/documents/download/${doc.filename}" target="_blank">Download</a><br>
                 <button onclick="deleteDoc(${doc.id})">Delete</button>`
              : ''}
          </td>
        `;
        table.appendChild(row);
      });
    }

    function changePage(offset) {
      const newPage = currentPage + offset;
      if (newPage < 1 || newPage > totalPages) return;
      currentPage = newPage;
      loadDocuments();
    }

    async function deleteDoc(id) {
      if (!confirm('Are you sure you want to delete this document?')) return;
      await fetch(`/api/documents/${id}`, { method: 'DELETE' });
      loadDocuments();
    }

    document.getElementById('uploadForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const res = await fetch('/api/documents/upload', {
        method: 'POST',
        body: formData
      });

      const result = await res.json();
      if (res.ok) {
        alert('Uploaded successfully');
        e.target.reset();
        loadDocuments();
      } else {
        alert(result.error || 'Upload failed');
      }
    });

    loadDocuments();
  </script>
</body>
</html>
